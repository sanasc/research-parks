# -*- coding: utf-8 -*-
"""safe-graph-census.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/13bxi3j6gxDlIEEdzGvJzUXOGEAJKMMph

Read the data
"""

import pandas as pd
import numpy as np
import sys
import matplotlib.pyplot as plt
import warnings
from datetime import datetime,date
import ast
import os

#parkdata=pd.read_csv("sharewithsana.csv")
#parkdata.columns=["placekey","safegraph_place_id","parent_placekey","parent_safegraph_place_id","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands","time","date_range_end","raw_visit_counts","raw_visitor_counts","visits_by_day","poi_cbg","visitor_home_cbgs","visitor_daytime_cbgs","visitor_country_of_origin","distance_from_home","median_dwell","bucketed_dwell_times","related_same_day_brand","related_same_month_brand","popularity_by_hour","popularity_by_day","device_type"]
#parkdata

!head -2 sharewithsana.csv

type(parkdata["visitor_home_cbgs"][1])

dict=ast.literal_eval(parkdata["visitor_home_cbgs"][1])
dict

data={"482015416024":246,"482015422001":206,"482015430031":139,"482015421022":132,"481576747002":129,"482015410021":115,"481576731011":105,"482015421011":78,"482015430021":67,"482014549002":58,"482015417002":54,"482015429003":50,"482012123003":47,"482015414001":47,"484530018241":45,"482015410032":42,"482015423021":42,"482015401001":40,"482015416011":38,"481576745021":37,"482015413002":37,"482015412032":37,"482015430022":36,"482015557021":36,"482015422002":36,"481576732002":35,"482015405011":34,"481576729001":33,"482014215003":31,"480219504004":31,"482015421012":29,"482015421021":28,"482015415001":28,"482015544031":28,"482015406022":28,"481576734001":27,"482015430011":27,"482015411001":26,"482015406021":26,"482015430012":25,"482015414002":25,"482015415002":25,"482015405022":25,"482015412012":24,"482014518002":24,"482015410031":24,"482015538023":24,"482015544012":24,"481576731012":23,"482012407012":23,"482015416023":22,"482015432002":22,"482015342031":21,"482015412021":21,"482015411003":20,"482015420001":20,"482015548011":20,"482014313022":19,"482015410011":19,"482015416021":19,"482015548021":19,"480396603003":19,"482015555022":18,"482012229003":18,"482015221003":18,"482015418001":17,"482015544022":17,"482014215001":17,"481576755001":17,"482015416022":17,"482015405013":17,"481576744003":17,"481576745022":17,"482015412024":17,"483396904024":17,"484910207012":17,"480396633002":16,"481677202002":16,"482015544011":16,"482015420002":16,"482015405021":16,"482014514021":16,"482015408001":15,"480396606022":15,"482015405012":15,"482015407002":15,"482015218001":15,"481576731021":15,"482015324003":14,"482015412011":13,"482015423012":13,"482015224021":13,"480913105022":13,"482015223011":13,"482015409011":13,"480219505012":12,"484530018413":12,"482015409021":12,"482015517032":12,"481576725003":12,"484690006013":12,"482015407001":12,"482015522003":12,"482014228002":12,"483396931013":12,"480396607011":11,"482015549031":11,"482015402001":11,"481576741001":11,"481576730032":11,"482015515002":11,"482015401003":11,"481677213003":11,"483396945002":11,"480291719162":11,"482015429002":11,"482015419002":11,"482015432003":10,"480410020082":10,"482015325013":10,"482015518001":10,"482013416002":10,"482015408002":10,"482012411024":10,"482014305002":10,"482015401002":10,"482014505002":10,"482015552001":10,"482015541021":10,"482015342011":10,"482015423013":10,"482015413003":10,"484736801001":10,"482015557012":10,"482014545013":10,"480410016061":10,"482015211001":10,"482014308001":10,"482012537004":10,"482015215002":10,"482015522002":9,"482450003022":9,"482015407003":9,"482015419001":9,"482015218002":9,"483396920021":9,"483396926021":9,"482015220003":9,"481130207001":9,"480396608012":9,"482014323004":9,"482014324003":9,"484530017471":9,"484790017111":9,"482015506011":9,"481576746022":9,"480157605012":8,"481872104002":8,"483396920022":8,"482015544021":8,"481576723011":8,"482012507022":8,"482015521021":8,"480410020081":8,"481576744001":8,"482012324011":8,"480396621002":8,"483396905001":8,"484910201121":8,"481576726022":8,"482015406012":8,"480396607015":8,"482012518001":8,"482015213003":8,"481239705003":8,"483130002001":7,"484639503004":7,"483396902012":7,"481677205031":7,"482015560002":7,"482015545012":7,"481576742001":7,"482015408003":7,"482014103002":7,"482015424001":7,"482014514032":7,"480396614002":7,"480913109011":7,"481576720014":7,"240276027002":7,"484736802003":7,"484910203171":7,"482014318011":7,"482012529001":7,"482015417001":7,"482015412022":7,"482015213002":7,"482014544001":7,"481576709021":7,"482015521011":7,"482014540001":7,"482012413003":7,"483396906022":7,"482015219002":7,"482015216001":7,"482015221001":7,"483396915002":7,"482015325011":7,"480410020132":7,"482015413004":7,"482012516002":7,"482015417003":7,"482014509001":7,"481576756001":7,"482012523021":7,"482015323004":7,"482015409023":7,"482015324002":7,"482015222012":7,"482015518003":7,"482015524003":6,"482014507001":6,"481576734002":6,"482015431001":6,"482015338012":6,"484530024332":6,"482015547002":6,"484771702001":6,"481576707002":6,"482015409022":6,"482014507002":6,"482015106002":6,"482014540002":6,"482014506002":6,"482013206011":6,"483396947002":6,"484530024351":6,"482015423014":6,"482012520001":6,"484717903002":6,"482015523011":6,"483396941015":6,"482012411032":6,"482013234001":6,"482013305001":6,"480396634004":6,"482013339023":6,"482015532001":6,"482015220002":6,"482014521002":6,"220330019001":6,"482013433022":6,"483396904011":6,"482013403012":6,"481872107141":6,"482014517001":6,"482012315002":6,"482012513004":6,"480291215052":6,"481990305012":6,"482014309004":6,"482015205001":6,"481576708003":6,"482014508022":6,"482599704022":6,"482014530002":6,"482014301003":6,"482014231002":6,"482014548002":6,"482013341002":6,"482015224013":6,"483396922003":6,"482015520013":6,"483610220003":6,"482015321001":6,"483396903003":6,"482014512002":6,"481130100001":6,"482012404001":6,"480610129002":6,"482014128001":5,"482015329003":5,"482014543021":5,"482014527002":5,"483396944003":5,"482012515021":5,"482014115011":5,"482012507011":5,"481576735001":5,"482012513002":5,"482659603011":5,"482015406011":5,"482012515011":5,"482090105002":5,"482015201001":5,"482014303003":5,"482015550003":5,"482015335003":5,"482013338004":5,"482014202001":5,"483550033062":5,"480291817314":5,"482150208033":5,"482015557011":5,"482570512021":5,"481576726015":5,"480291918062":5,"482013501002":5,"481576731013":5,"482014519012":5,"482014325002":5,"484771701003":5,"482015338011":5,"482015214002":5,"484736802001":5,"481872107091":5,"482011000003":5,"482013428001":5,"482015214004":5,"482015216002":5,"482015413001":5,"480291719234":5,"480396604001":5,"480219502003":5,"482015517012":5,"483396942013":5,"482090108031":5,"484910203192":5,"483396903001":5,"484717905004":5,"483396905002":5,"481576718002":5,"482090101001":5,"482014123003":5,"482015424002":5,"484090113001":5,"481576720013":5,"482015224022":5,"482014535021":5,"481576728001":5,"482015213004":5,"130299203062":5,"482012231001":5,"482015517031":5,"484530013072":5,"482013501001":5,"482870004003":5,"483217303031":5,"220630408022":5,"482015222022":5,"484530017801":5,"482015527001":5,"483396931022":5,"480410020102":5,"482015513001":5,"482013227001":5,"484930001031":5,"482012407022":5,"481719502003":4,"482917005002":4,"484530018582":4,"480410018012":4,"482015550001":4,"482013228003":4,"482013423001":4,"480410002021":4,"482015509002":4,"480219508011":4,"482015342024":4,"481576743003":4,"482013409002":4,"360471164002":4,"482013110004":4,"482090105001":4,"480291817163":4,"350350003054":4,"480291419003":4,"480157605013":4,"482014551021":4,"180190506061":4,"480717102002":4,"482012321002":4,"482012410001":4,"482012219003":4,"483396906014":4,"484530017421":4,"480410006033":4,"480999800001":4,"482015206023":4,"482012210001":4,"482014332021":4,"482015551001":4,"484790017152":4,"482015534011":4,"481576745011":4,"483396914002":4,"482012407021":4,"482015220001":4,"040070011005":4,"481576739012":4,"481576710013":4,"480291216042":4,"482012529003":4,"480291316152":4,"480410018011":4,"482015203001":4,"482015320011":4,"484199505001":4,"482012212003":4,"483217306004":4,"482014523001":4,"390930701023":4,"482013241002":4,"484690016063":4,"482015301002":4,"482015520011":4,"483550024001":4,"482015541023":4,"481677240001":4,"484736802004":4,"482014549001":4,"482015517016":4,"483550032041":4,"483396922001":4,"482015555012":4,"482012322004":4,"483396919003":4,"482013131002":4,"482015555011":4,"484391141035":4,"484679510003":4,"480291802023":4,"483396937001":4,"484530017161":4,"482015536001":4,"482015217001":4,"482015543022":4,"482013503001":4,"482015225002":4,"482013424001":4,"131210035001":4,"482012312001":4,"483396926011":4,"481872107093":4,"481499706002":4,"480291218031":4,"482259505001":4,"483396933003":4,"482014219001":4,"481990305011":4,"482012502001":4,"483396921002":4,"482730201001":4,"482015429001":4,"482090109051":4,"482015410012":4,"482570502011":4,"481576705002":4,"480410020101":4,"482013406001":4,"481576727012":4,"484530017663":4,"482015538011":4,"482014311021":4,"060855086021":4,"482014313011":4,"482014227013":4,"482090109011":4,"481770002001":4,"480050006004":4,"480913106051":4,"482450108001":4,"482015534031":4,"480410018041":4,"280750006003":4,"482012517001":4,"482015341002":4,"480291913031":4,"482015418002":4,"482014520002":4,"480319501003":4,"484090102023":4,"481576730021":4,"482014516011":4,"482014502003":4,"482012541004":4,"484530017642":4,"482014528013":4,"482090108082":4,"482014552002":4,"482015543012":4,"482015206011":4,"480291720071":4,"480291408005":4,"482012209002":4,"482015556001":4,"482015534012":4,"484910204061":4,"482015512003":4,"482014311022":4,"482015528003":4,"482015547001":4,"482015527002":4,"482014321001":4,"480410020092":4,"482979501002":4,"483250001022":4,"482917003001":4,"132231205011":4,"482014332013":4,"482015530012":4,"482012203003":4,"211110115061":4,"482014542002":4,"480291619011":4,"482012507021":4,"483550036014":4,"481576733001":4,"480717102005":4,"482014553001":4,"482015217003":4,"480539601002":4,"482012108002":4,"482014236004":4,"482014106001":4,"482014120003":4,"482015342023":4,"482319607003":4,"484391104024":4,"482014319002":4,"483396921001":4,"482015560001":4,"480270224021":4,"482014543022":4,"482012323022":4,"480396607014":4,"483396904025":4,"482014320023":4,"131570106001":4,"482013303011":4,"480291219102":4,"484530018213":4,"481677205032":4,"480396607022":4,"482013421002":4,"482015521032":4,"483396902022":4,"480291620042":4,"482014323001":4,"482014229001":4,"482015212003":4,"481677212014":4,"480190002001":4,"482015320021":4,"482015504021":4,"480291216013":4,"480850317144":4,"482015538022":4,"483250005004":4,"484736803004":4,"482012332002":4,"482014503004":4,"484736803005":4,"481576757002":4,"482450113042":4,"250173686001":4,"482014209002":4,"482150208043":4,"482499507003":4,"482450112015":4,"480396608023":4,"483090042022":4,"481576726014":4,"482012506001":4,"483859501002":4,"170313006001":4,"480259502022":4,"483550059001":4,"482014221001":4,"480717102003":4,"480291615042":4,"482090108043":4,"482014511003":4,"484910215042":4,"482015224014":4,"482014516022":4,"483550027043":4,"481576720012":4,"480559604001":4,"481576742004":4,"482015517011":4,"480019507002":4,"482014505001":4,"482015554022":4,"483396906013":4,"170318226012":4,"481210217511":4,"482012503011":4,"482012111006":4,"484530019132":4,"484771703002":4,"481130136192":4,"482014115024":4,"482150242052":4,"483396926022":4,"482012415001":4,"483217302017":4,"481576702001":4,"480897504004":4,"510619303024":4,"482015517015":4,"484930002021":4,"484391139227":4,"482015205002":4,"220330040064":4,"483396930002":4,"482012501001":4,"482015533001":4,"484910205104":4,"481576741004":4,"483550031021":4,"482090109024":4,"482014551011":4,"481677213004":4,"482015323003":4,"482015223021":4,"483239506022":4,"482015521031":4,"482013424002":4,"482450111014":4,"483396902021":4,"482090103022":4,"483396904021":4,"482012413001":4,"480396608022":4,"480396621001":4,"480291922001":4,"482015531004":4,"480410002024":4,"482014502002":4,"010890017001":4,"484771704002":4,"220330040061":4,"480291818192":4,"482015340022":4,"481576738003":4,"481851802003":4,"482012409011":4,"482015110011":4,"482015219003":4,"480850317112":4,"483550054162":4,"480410004002":4,"483396942025":4,"484910201052":4,"482012205001":4,"482015542001":4,"482917011003":4,"482013302001":4,"482012513005":4,"480219504005":4,"480897502001":4,"484530023181":4,"483396902013":4,"482015539003":4,"483396928011":4,"482090109012":4,"481576713001":4,"484717908001":4,"170938904001":4,"482014308002":4,"484910207082":4,"482014123005":4,"481576706014":4,"484072001023":4,"482015204002":4,"482014516021":4,"482012531001":4,"482014529001":4,"482015517022":4,"130890216033":4,"482015322001":4,"483396918005":4,"480291605021":4,"480410001022":4,"481759601001":4,"482012226001":4,"482013437003":4,"480410020151":4,"482012516001":4,"482015207004":4,"482012515022":4,"484090106021":4,"483396932001":4,"483217302013":4,"483090042011":4,"482659603023":4,"482014124002":4,"482015552002":4,"482150241102":4,"482014525002":4,"482014504001":4,"481576703001":4,"483396946002":4,"482012523022":4,"482013115001":4,"482012505001":4,"482015340031":4,"482014332022":4,"482013502001":4,"483550051021":4,"483396902025":4,"080310069014":4,"482014212021":4,"482012519022":4,"482013401001":4,"482014507003":4,"482012215003":4,"482015549011":4,"481499705002":4,"484530018392":4,"482012124002":4,"484039501001":4,"484230020083":4,"482015553031":4,"482012230022":4,"482014226002":4,"482917007001":4,"480410020142":4,"482014131003":4,"220430204012":4,"482015335002":4,"483396902023":4,"482014530003":4,"481576730012":4,"482150221041":4,"480396629002":4,"482015521022":4,"482679501001":4,"201730100043":4,"482015223022":4,"482014524001":4,"480539602001":4,"481677239002":4,"481576726011":4,"482012517003":4,"482015534022":4,"480410020121":4,"482015526011":4,"482015542002":4,"480897502002":4,"482014232022":4,"482014547004":4,"481576739021":4,"482659606004":4,"480259503001":4,"481677207002":4,"482014522013":4,"480291720073":4,"484391139282":4,"480396624003":4,"484530006012":4,"483396944001":4,"484790017181":4,"482015529001":4,"484530017682":4,"482450067001":4,"484530017661":4,"482015325023":4,"482014522021":4,"482014207003":4,"482012227001":4,"484790018142":4,"482013117001":4,"484910205101":4,"481677205033":4,"482014210002":4,"482013335002":4,"482014543013":4,"482012519013":4,"482015420004":4,"480291719161":4,"482012519021":4,"482013427003":4,"482014528022":4,"483610222002":4,"481239703001":4,"481990303002":4,"481851802005":4,"484530017732":4,"484790017101":4,"480157603003":4,"480610123012":4,"483959603002":4,"482013338001":4,"480410020012":4,"482013502002":4,"482015510001":4,"481576733002":4,"482015523012":4,"482015428002":4,"483130001001":4,"482014324002":4,"482014110001":4,"482012501003":4,"482015104002":4,"482015535001":4,"482015428003":4,"480291204005":4,"482014514031":4,"482015206021":4,"480396602003":4,"483396907002":4,"220630408051":4,"482013205001":4,"482014133002":4,"482012515031":4,"480291813012":4,"482012405011":4,"482014520003":4,"482012504023":4,"482014535011":4,"481499707002":4,"482013140023":4,"484930003001":4,"481499706005":4,"060371436023":4,"480396627001":4,"482014539003":4,"483396935004":4,"040138103002":4,"483550062003":4,"482015504011":4,"480291918131":4,"484717905002":4,"484530024071":4,"481576748001":4,"480913109032":4,"481576719003":4,"482015207002":4,"482014525001":4,"482015412023":4,"482015340011":4,"483396906023":4,"481576726013":4,"482014536022":4,"482012509002":4,"482014126002":4,"482499505004":4,"482012224023":4,"480050003012":4,"481851803011":4,"480396606013":4,"481576754002":4,"100010402021":4,"482012529004":4,"482015306001":4,"483396928021":4,"482015530022":4,"482014132022":4,"482014228001":4,"483550032023":4,"482450070013":4,"482013309001":4,"180731012001":4,"482090109073":4,"482839503003":4,"482013107001":4,"482150225023":4,"482013111003":4,"481390602143":4,"482090109104":4,"482014116002":4,"482015522001":4,"482014515001":4,"482013101002":4,"482014221004":4,"481576738001":4,"481130014002":4,"483396940003":4,"482014510013":4,"482015322002":4,"481677206001":4,"482015315001":4,"482012218001":4,"482012322003":4,"481576727022":4,"482014524003":4,"482015217002":4,"480291811003":4,"483319505002":4,"480219508021":4,"180890217004":4,"480539602002":4,"481576727013":4,"482014502001":4,"482559704001":4,"482659606005":4,"281230203001":4,"482014304001":4,"483396943012":4,"482014546001":4,"482014503002":4,"480410009001":4,"220570207031":4,"482012529005":4,"481677233002":4,"484817404001":4,"484391110162":4,"481130205002":4,"482015517033":4,"060375719004":4,"482015411002":4,"484530019183":4,"480139601004":4,"482012414001":4,"480396615022":4,"482015545022":4,"482015206022":4,"482014516012":4,"060372074001":4,"480291912022":4,"482012213005":4,"482015416012":4,"482013507002":4,"482012224021":4,"482013315001":4,"480291919001":4,"483396920012":4,"481576708001":4,"482015534024":4,"482015424003":4,"481576751003":4,"482014519014":4,"482015555021":4,"060730165022":4,"480291517004":4,"484910205081":4,"481130167033":4,"480291918141":4,"482015548022":4,"481576725001":4,"482015112002":4,"481576727021":4,"484090107001":4,"480219503005":4,"481319502001":4,"220510223031":4,"482012323021":4,"240217510023":4,"480291208005":4,"481872107123":4,"482014216003":4,"482450003043":4,"482013220003":4,"482014501001":4,"482014301004":4,"481576735002":4,"483396931014":4,"481576746041":4,"482019801001":4,"483550027042":4,"483610224001":4,"482015427001":4,"480291313003":4,"482013238022":4,"482015341003":4,"482012525001":4,"482015519003":4,"482013106002":4,"484717903003":4,"482015324001":4,"480291918091":4,"482014224024":4,"480396631004":4,"482013135002":4,"483130004002":4,"482012504021":4,"482014303002":4,"480291713021":4,"480291205017":4,"482015222021":4,"481677219001":4,"482013415012":4,"482015215004":4,"484391139292":4,"481576717001":4,"482013506012":4,"480291101002":4,"482012529002":4,"482014543011":4,"482015524002":4,"480396618002":4,"481576755002":4,"482013236003":4,"481576726021":4,"482015108005":4,"482015504012":4,"483479509001":4,"482015517013":4,"482012302004":4,"482015341001":4,"483396943011":4,"482013201002":4,"482015520021":4,"484391140074":4,"482012515024":4,"484530018462":4,"482014551013":4,"482090109064":4,"482011000001":4,"480396606021":4,"482015219001":4,"482015540011":4,"483396925004":4,"480291219092":4,"482012228002":4,"482014545012":4,"482012502002":4,"230190020005":4,"482015334002":4,"482015225003":4,"482450108004":4,"481576741002":4,"482015526021":4,"482015405023":4,"483396923003":4,"482014203003":4,"482014528021":4,"482014314021":4,"483130004001":4,"481576702003":4,"482015321004":4,"484817404003":4,"482013234002":4,"482014503001":4,"483396923001":4,"484910203011":4}

!wget https://raw.githubusercontent.com/muellermax/Covid-19-USA-social-vulnerability/master/SVI2018_US.csv


svi = pd.read_csv('SVI2018_US.csv')
#svi = svi[['STATE', 'STCNTY','COUNTY','FIPS', 'EP_POV', 'EP_LIMENG', 'EP_AGE65', 'EP_MINRTY', 'EP_UNEMP', 'EP_NOHSDP', 'EP_AGE17', 'EP_DISABL', 'EP_SNGPNT', 'EP_MUNIT', 'EP_MOBILE', 'EP_CROWD', 'EP_NOVEH', 'EP_GROUPQ','RPL_THEME1', 'RPL_THEMES']]
svi = svi[['STATE', 'STCNTY','COUNTY','FIPS', 'RPL_THEME1', 'RPL_THEMES']]

svi = svi.rename(columns = {'STCNTY': 'county_fips'})

# Drop all -999/NaN columns in the dataframe
svi = svi[svi[svi.columns] != -999]
svi = svi.dropna()

"""Get a list of low IQ SVI of FIPS

"""

lowRPL1=svi[svi['RPL_THEME1']< 0.25]
highRPL1=svi[svi['RPL_THEME1']> 0.75]
lowFIPS=lowRPL1['FIPS'].astype(str).tolist()
highFIPS=highRPL1['FIPS'].astype(str).tolist()
allFIPS=[]
allFIPS=svi['FIPS'].astype(str).tolist()
len(allFIPS)

"""look up any FIPS

"""

def lookup_FIPS(id):
   #print(id[:11])
   if id[:11] in highFIPS:
      return 1
   return 0  
lookup_FIPS("482015432002")

import os

for filename in os.listdir("/content/drive/Shareddrives/Pandemic Paper/safegraph/BasedOnSanaShapeFiles/Houston"):
    if filename.endswith("csv"): 
        # Your code comes here such as 
        print(filename)

        parkdata=pd.read_csv("/content/drive/Shareddrives/Pandemic Paper/safegraph/BasedOnSanaShapeFiles/Houston/"+ filename)
        parkdata.columns=["placekey","safegraph_place_id","parent_placekey","parent_safegraph_place_id","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands","time","date_range_end","raw_visit_counts","raw_visitor_counts","visits_by_day","poi_cbg","visitor_home_cbgs","visitor_daytime_cbgs","visitor_country_of_origin","distance_from_home","median_dwell","bucketed_dwell_times","related_same_day_brand","related_same_month_brand","popularity_by_hour","popularity_by_day","device_type"]


        x=len(parkdata)
        res=[]
        #park_status=lookup_FIPS(parkdata["poi_cbg"][1])
        for index, row in parkdata.iterrows():
            dict=ast.literal_eval(row["visitor_home_cbgs"])
            y=sum([v for k, v in dict.items() if k[:11] in highFIPS])
            w=(y)/int(row["raw_visitor_counts"])
            res.append(w)
            #print(index)

            
        print(res)
        parkdata.insert(1,"low_svi_percentage", res,False)
        parkdata.to_csv('/content/drive/Shareddrives/Pandemic Paper/safegraph/BasedOnSanaShapeFiles/Processed/Houston.csv', mode='a', header=False)

# parkdata=pd.read_csv("sharewithsana.csv")
# parkdata.columns=["placekey","safegraph_place_id","parent_placekey","parent_safegraph_place_id","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands","time","date_range_end","raw_visit_counts","raw_visitor_counts","visits_by_day","poi_cbg","visitor_home_cbgs","visitor_daytime_cbgs","visitor_country_of_origin","distance_from_home","median_dwell","bucketed_dwell_times","related_same_day_brand","related_same_month_brand","popularity_by_hour","popularity_by_day","device_type"]


# x=len(parkdata)
# res=[]
# #park_status=lookup_FIPS(parkdata["poi_cbg"][1])
# for index, row in parkdata.iterrows():
#     dict=ast.literal_eval(row["visitor_home_cbgs"])
#     y=sum([v for k, v in dict.items() if k[:11] in lowFIPS])
#     w=(y)/int(row["raw_visitor_counts"])
#     res.append(w)
#     print(index)

    
# print(res)
# parkdata.insert(1,"low_svi_percentage", res,False)

"""import aggregate csv"""

import pandas as pd

parkdata=pd.read_csv("/content/drive/Shareddrives/Pandemic Paper/safegraph/BasedOnSanaShapeFiles/Processed/Houston.csv")
parkdata.columns=["index","placekey","low_svi_percentage","safegraph_place_id","parent_placekey","parent_safegraph_place_id","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands","time","date_range_end","raw_visit_counts","raw_visitor_counts","visits_by_day","poi_cbg","visitor_home_cbgs","visitor_daytime_cbgs","visitor_country_of_origin","distance_from_home","median_dwell","bucketed_dwell_times","related_same_day_brand","related_same_month_brand","popularity_by_hour","popularity_by_day","device_type"]

parkdata['Date'] =pd.to_datetime(parkdata["time"].str[0:10])


parkdata.sort_values('Date')
start_date='2018-01-01'
end_date='2019-12-30'

mask1 = (parkdata['Date'] <= end_date ) 
mask2 =  (parkdata['Date'] > end_date) & (parkdata['Date'] < "2020-12-30") 
parkdata1=parkdata.loc[mask1]
parkdata2=parkdata.loc[mask2]

parkdata

import scipy.stats as stats
import statistics

stats.ttest_ind(parkdata1['low_svi_percentage'],
                parkdata2['low_svi_percentage'],equal_var=True)
#statistics.mean((parkdata1['low_svi_percentage']))

stats.ttest_ind(parkdata1['raw_visitor_counts'],
                parkdata2['raw_visitor_counts'],equal_var=True)

parkdata
parkdata=parkdata.drop(["index","placekey","raw_visit_counts","safegraph_place_id","Date","low_svi_percentage","parent_placekey","parent_safegraph_place_id","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands","date_range_end","visits_by_day","poi_cbg","visitor_home_cbgs","visitor_daytime_cbgs","visitor_country_of_origin","distance_from_home","median_dwell","bucketed_dwell_times","related_same_day_brand","related_same_month_brand","popularity_by_hour","popularity_by_day","device_type"] , axis=1)

parkdata['time']=pd.to_datetime(parkdata["time"].str[0:10])

parkdata=parkdata.groupby('time', as_index=False).sum()

start_date='2018-01-01'
end_date='2022-12-30'
mask = (parkdata['time'] > start_date ) & (parkdata['time'] <= end_date)
parkdata=parkdata.loc[mask]

parkdata

from kats.consts import TimeSeriesData

from kats.models.prophet import ProphetModel, ProphetParams

parkdf=TimeSeriesData(parkdata)


from kats.models.sarima import SARIMAModel, SARIMAParams
warnings.simplefilter(action='ignore')

# create SARIMA param class
params = SARIMAParams(
    p = 2, 
    d=1, 
    q=1, 
    trend = 'ct', 
    seasonal_order=(1,0,1,12)
    )

# initiate SARIMA model
m = SARIMAModel(data=parkdf, params=params)

 #fit SARIMA model
m.fit()

# generate forecast values
fcst = m.predict(
   steps=1, 
   freq="MS"
   )

#tb=m.predict(steps=17, freq="MS")

# make plot to visualize
m.plot()

!pip install kats